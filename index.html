// 수정된 drawSun 함수 - 퍼포먼스 개선 및 멈춤 현상 제거
// 문제 원인: drawSun 내 연산 과다 및 requestAnimationFrame 차단
// 해결 방식: canvas에 한 번만 렌더링한 태양 이미지를 캐싱하여 사용

class UFOGame {
  constructor() {
    this.canvas = document.getElementById("gameCanvas");
    this.ctx = this.canvas.getContext("2d");
    this.sunCanvas = null;
    this.sunCtx = null;
    this.sunImageGenerated = false;
    this.generateSunImage(); // 한 번만 생성
  }

  generateSunImage() {
    const sunSize = 150;
    const pixelSize = 5;
    const gridSize = Math.floor(sunSize / pixelSize);
    const centerX = gridSize / 2;
    const centerY = gridSize / 2;
    const canvas = document.createElement("canvas");
    canvas.width = sunSize;
    canvas.height = sunSize;
    const ctx = canvas.getContext("2d");

    for (let row = 0; row < gridSize; row++) {
      for (let col = 0; col < gridSize; col++) {
        const dx = col - centerX;
        const dy = row - centerY;
        const distance = Math.sqrt(dx * dx + dy * dy);

        if (distance < centerX - 1.5) {
          const intensity = 1 - distance / centerX;
          const hue = 30;
          const lightness = 50 + intensity * 40;
          ctx.fillStyle = `hsl(${hue}, 100%, ${lightness}%)`;
          ctx.fillRect(
            col * pixelSize,
            row * pixelSize,
            pixelSize,
            pixelSize
          );
        }
      }
    }

    this.sunCanvas = canvas;
    this.sunCtx = ctx;
    this.sunImageGenerated = true;
  }

  drawSun(x, y) {
    if (this.sunImageGenerated && this.sunCanvas) {
      this.ctx.drawImage(this.sunCanvas, x, y);
    }

    // 광선 효과는 실시간 연산 가능하므로 유지
    const rayCount = 16;
    const sunSize = 150;
    const time = Date.now() * 0.003;
    const sunCenterX = x + sunSize / 2;
    const sunCenterY = y + sunSize / 2;

    this.ctx.strokeStyle = `rgba(255, 200, 0, 0.8)`;
    this.ctx.lineWidth = 4;

    for (let i = 0; i < rayCount; i++) {
      const angle = (i / rayCount) * Math.PI * 2 + time;
      const rayLength = 80 + Math.sin(time * 2 + i) * 20;
      const rayX = sunCenterX + Math.cos(angle) * rayLength;
      const rayY = sunCenterY + Math.sin(angle) * rayLength;

      this.ctx.beginPath();
      this.ctx.moveTo(sunCenterX, sunCenterY);
      this.ctx.lineTo(rayX, rayY);
      this.ctx.stroke();
    }
  }
}
